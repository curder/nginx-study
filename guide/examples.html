<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一些示例 | Nginx 学习</title>
    <meta name="description" content="Nginx 学习记录">
    <meta name="generator" content="VitePress v1.1.0">
    <link rel="preload stylesheet" href="/nginx-study/assets/style.DupSrtRo.css" as="style">
    
    <script type="module" src="/nginx-study/assets/app.DXPlzPJN.js"></script>
    <link rel="preload" href="/nginx-study/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/nginx-study/assets/chunks/framework.CrCg5V4F.js">
    <link rel="modulepreload" href="/nginx-study/assets/chunks/theme.CHBabgsc.js">
    <link rel="modulepreload" href="/nginx-study/assets/guide_examples.md.DwiHn2GK.lean.js">
    <link rel="icon" href="/nginx-study/images/favicon.ico">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5d98c3a5><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0f60ec36></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0f60ec36> Skip to content </a><!--]--><!----><header class="VPNav" data-v-5d98c3a5 data-v-ae24b3ad><div class="VPNavBar top" data-v-ae24b3ad data-v-ccf7ddec><div class="wrapper" data-v-ccf7ddec><div class="container" data-v-ccf7ddec><div class="title" data-v-ccf7ddec><div class="VPNavBarTitle" data-v-ccf7ddec data-v-ab179fa1><a class="title" href="/nginx-study/" data-v-ab179fa1><!--[--><!--]--><!--[--><img class="VPImage logo" src="/nginx-study/images/logo.svg" alt data-v-8426fc1a><!--]--><span data-v-ab179fa1>Nginx 学习</span><!--[--><!--]--></a></div></div><div class="content" data-v-ccf7ddec><div class="content-body" data-v-ccf7ddec><!--[--><!--]--><div class="VPNavBarSearch search" data-v-ccf7ddec><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-ccf7ddec data-v-7f418b0f><span id="main-nav-aria-label" class="visually-hidden" data-v-7f418b0f>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/nginx-study/guide/install.html" tabindex="0" data-v-7f418b0f data-v-9c663999><!--[--><span data-v-9c663999>安装</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink active" href="/nginx-study/guide/examples.html" tabindex="0" data-v-7f418b0f data-v-9c663999><!--[--><span data-v-9c663999>示例</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-ccf7ddec data-v-e6aabb21><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-e6aabb21 data-v-d1f28634 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-d1f28634></span><span class="vpi-moon moon" data-v-d1f28634></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-ccf7ddec data-v-0394ad82 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/curder/nginx-study" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-eee4e7cb><span class="vpi-social-github" /></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-ccf7ddec data-v-d0bd9dde data-v-b6c34ac9><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-b6c34ac9><span class="vpi-more-horizontal icon" data-v-b6c34ac9></span></button><div class="menu" data-v-b6c34ac9><div class="VPMenu" data-v-b6c34ac9 data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-d0bd9dde><div class="item appearance" data-v-d0bd9dde><p class="label" data-v-d0bd9dde>Appearance</p><div class="appearance-action" data-v-d0bd9dde><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-d0bd9dde data-v-d1f28634 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-d1f28634></span><span class="vpi-moon moon" data-v-d1f28634></span><!--]--></span></span></button></div></div></div><div class="group" data-v-d0bd9dde><div class="item social-links" data-v-d0bd9dde><div class="VPSocialLinks social-links-list" data-v-d0bd9dde data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/curder/nginx-study" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-eee4e7cb><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-ccf7ddec data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-ccf7ddec><div class="divider-line" data-v-ccf7ddec></div></div></div><!----></header><div class="VPLocalNav empty fixed" data-v-5d98c3a5 data-v-a6f0e41e><div class="container" data-v-a6f0e41e><!----><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-a6f0e41e data-v-267dd0ed><button data-v-267dd0ed>Return to top</button><!----></div></div></div><!----><div class="VPContent" id="VPContent" data-v-5d98c3a5 data-v-1428d186><div class="VPDoc has-aside" data-v-1428d186 data-v-39a288b8><!--[--><!--]--><div class="container" data-v-39a288b8><div class="aside" data-v-39a288b8><div class="aside-curtain" data-v-39a288b8></div><div class="aside-container" data-v-39a288b8><div class="aside-content" data-v-39a288b8><div class="VPDocAside" data-v-39a288b8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-3f215769 data-v-935f8a84><div class="content" data-v-935f8a84><div class="outline-marker" data-v-935f8a84></div><div class="outline-title" role="heading" aria-level="2" data-v-935f8a84>章节导航</div><nav aria-labelledby="doc-outline-aria-label" data-v-935f8a84><span class="visually-hidden" id="doc-outline-aria-label" data-v-935f8a84> Table of Contents for current page </span><ul class="VPDocOutlineItem root" data-v-935f8a84 data-v-b933a997><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-39a288b8><div class="content-container" data-v-39a288b8><!--[--><!--]--><main class="main" data-v-39a288b8><div style="position:relative;" class="vp-doc _nginx-study_guide_examples" data-v-39a288b8><div><h1 id="一些示例" tabindex="-1">一些示例 <a class="header-anchor" href="#一些示例" aria-label="Permalink to &quot;一些示例&quot;">​</a></h1><h2 id="添加1个像素的gif图" tabindex="-1">添加1个像素的gif图 <a class="header-anchor" href="#添加1个像素的gif图" aria-label="Permalink to &quot;添加1个像素的gif图&quot;">​</a></h2><p>Nginx 提供一个模块，叫做 <a href="http://nginx.org/en/docs/http/ngx_http_empty_gif_module.html" target="_blank" rel="noreferrer"><code>ngx_http_empty_gif_module</code></a>，用于生成一个 <code>1x1</code> 像素的透明 GIF 图片。</p><p>这个模块已经内置在标准的 Nginx 发行版中，所以不需要额外安装任何东西。只需要在 Nginx 配置文件中定义一个 <code>location</code> 来使用这个模块。</p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">location</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> /assets/images/common/1.gif </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    empty_gif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="添加或删除-www-子域名" tabindex="-1">添加或删除 <code>www</code> 子域名 <a class="header-anchor" href="#添加或删除-www-子域名" aria-label="Permalink to &quot;添加或删除 `www` 子域名&quot;">​</a></h2><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-yZC2B" id="tab-h9qGlDl" checked="checked"><label for="tab-h9qGlDl">添加 www 子域名</label><input type="radio" name="group-yZC2B" id="tab-96irjCT"><label for="tab-96irjCT">删除 www 子域名</label></div><div class="blocks"><div class="language-nginx vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    listen </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">80</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    listen </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">443</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ssl;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    server_name </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">domain.com;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 301</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $scheme://www.domain.com$request_uri;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 不推荐使用 rewrite</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">rewrite</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ^(.*)$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $scheme://www.domain.com$1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">permanent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    listen </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">80</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    listen </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">443</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ssl;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    server_name </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">www.domain.com;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 301</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $scheme://domain.com$request_uri;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></div></div><h2 id="强制所有请求使用-ssl-tls" tabindex="-1">强制所有请求使用 SSL/TLS <a class="header-anchor" href="#强制所有请求使用-ssl-tls" aria-label="Permalink to &quot;强制所有请求使用 SSL/TLS&quot;">​</a></h2><p>此 server 块强制所有访问者使用安全 (SSL/TLS) 连接到站点。</p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    listen </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">80</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    server_name </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">www.domain.com;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 301</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> https://www.domain.com$request_uri;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 不推荐使用 rewrite 重写规则</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($scheme </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!= </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    rewrite</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ^ https://www.mydomain.com$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">uri </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">permanent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="禁止对不支持的文件扩展名的请求" tabindex="-1">禁止对不支持的文件扩展名的请求 <a class="header-anchor" href="#禁止对不支持的文件扩展名的请求" aria-label="Permalink to &quot;禁止对不支持的文件扩展名的请求&quot;">​</a></h2><p>由于各种原因，站点可能会收到以与未运行的应用程序服务器相对应的文件扩展名结尾的请求 URL，而服务器处理的文件类型的请求无法得到服务，需要被拒绝。</p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">location</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ~</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> .(aspx|php|jsp|cgi)$ </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 410</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>它相对于 404 响应代码的优势在于它明确指示资源永久不可用，因此客户端不会再次发送请求。</p><h2 id="禁止访问站点某些前缀" tabindex="-1">禁止访问站点某些前缀 <a class="header-anchor" href="#禁止访问站点某些前缀" aria-label="Permalink to &quot;禁止访问站点某些前缀&quot;">​</a></h2><p>在站点需要迁移的时候，站点对应的后台不想让用户对数据进行编辑，可以通过配置 Nginx 禁止访问站点的某些域名前缀。</p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">location</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ~*</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> /admin </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 403</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>这样配置的话，再访问前缀为 <code>/admin</code> 就会返回 <strong>403 Forbidden</strong>；</p><h2 id="配置自定义重新路由" tabindex="-1">配置自定义重新路由 <a class="header-anchor" href="#配置自定义重新路由" aria-label="Permalink to &quot;配置自定义重新路由&quot;">​</a></h2><p>现在通过重新配置自定义的路由，URL <code>http://mysite.com/list/123</code> 用户友好的被重写为由<code>list.html</code> 控制器处理的 URL <code>http://mysite.com/list.html?arg=123</code></p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">rewrite</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ^/list/(.*)$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /list.html?arg=$1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">last</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><h2 id="修复失败图片路径" tabindex="-1">修复失败图片路径 <a class="header-anchor" href="#修复失败图片路径" aria-label="Permalink to &quot;修复失败图片路径&quot;">​</a></h2><p>在迁移项目时会出现一些图片不在原来的图片位置。比如访问URL <code>http://mysite.com/uploads/images/example.png</code> 图片<code>example.png</code> 实际所在路径是 <code>/uploads/example.png</code>，此时可以通过 <code>rewrite</code> 对路径进行重写：</p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">rewrite</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ^/uploads/images/(.*)$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /uploads/$1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">last</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>这样配置后，在访问 <code>http://mysite.com/uploads/images/exmaple.png</code> 也能访问 <code>/uploads/example.png</code> 文件。</p><h2 id="图片缺失时使用默认图片" tabindex="-1">图片缺失时使用默认图片 <a class="header-anchor" href="#图片缺失时使用默认图片" aria-label="Permalink to &quot;图片缺失时使用默认图片&quot;">​</a></h2><p>当一些原因导致图片无法访问，可以临时使用一张默认图片作为展示。</p><p>比如文章封面或文章内容图，<code>https://mysite.com/storage/uploads/images/xx.png</code> 或者 <code>https://mysite.com/storage/posts/cover/images/xx.png</code> 无法访问，当出现上面的图片地址无法访问时展示一张默认的图片。</p><p>可以使用 nginx 提供的 <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#try_files" target="_blank" rel="noreferrer"><code>try_files</code> 指令</a></p><p><strong>注意：默认图片必须可以访问。</strong></p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 假定默认的图片存放在项目 /images/default.jpg</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">location</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ~*</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ^\/storage\/(uploads|posts\/cover)\/images.*\.(png|gif|jpg|jpeg)$ </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{ </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 正则匹配url前缀</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       root </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/var/www/codes/{PROJECT_NAME}; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 这里编写项目根目录</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       try_files </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$uri /images/default.jpg; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 这里提供默认文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">location</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> /images/default.jpg </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    expires </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">max</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="允许部分ip访问-其它ip则301跳转" tabindex="-1">允许部分IP访问，其它IP则301跳转 <a class="header-anchor" href="#允许部分ip访问-其它ip则301跳转" aria-label="Permalink to &quot;允许部分IP访问，其它IP则301跳转&quot;">​</a></h2><p>在站点需要跳转到其它站点时，Nginx可以指定部分IP不跳转，可以通过下面的配置实现：</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-hrHFB" id="tab-XY97gQz" checked="checked"><label for="tab-XY97gQz">单个IP</label><input type="radio" name="group-hrHFB" id="tab-EOecpN4"><label for="tab-EOecpN4">多个IP</label></div><div class="blocks"><div class="language-nginx vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 当 IP 不等于 `127.0.0.1` 时就跳转到其它域名</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">location</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> / </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($remote_addr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!~ </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">127.0.0.1) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 301</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> https://redirect_domain;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 当 IP 不等于 `127.0.0.1` 或 `192.168.1.1` 时就跳转到其它域名</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">location</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> / </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($remote_addr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!~ </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(127.0.0.1|192.168.1.1)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 301</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> https://redirect_domain;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></div></div><blockquote><p><code>$remote_addr</code> 指的是客户端的 IP 地址，如果上层使用了负载均衡可以尝试获取 <code>$http_x_forwarded_for</code> 的值</p></blockquote><h2 id="添加用户名和密码http验证" tabindex="-1">添加用户名和密码HTTP验证 <a class="header-anchor" href="#添加用户名和密码http验证" aria-label="Permalink to &quot;添加用户名和密码HTTP验证&quot;">​</a></h2><p>在 Nginx 设置 HTTP 认证需要使用 <a href="https://httpd.apache.org/docs/2.4/programs/htpasswd.html" target="_blank" rel="noreferrer">httpasswd</a> 来创建和生成加密的用户用于基础认证。</p><ol><li><p>下载工具</p><p>生成对应的用户名和密码信息前需要先下载 httpasswd 工具，针对不同的操作系统下载的软件包不同。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> yum</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> httpd-tools</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # CentOS</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt-get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apache2-utils</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # Ubuntu</span></span></code></pre></div></li><li><p>创建用户名和密码 在 nginx 提供服务的网站目录下创建一个 <code>.htpasswd</code> 文件。以下命令将创建该文件并向其中添加用户和加密密码。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> htpasswd</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/nginx/.htpasswd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exampleuser</span></span></code></pre></div><p>运行命令后会提示输入密码 <code>New password: Re-type new password: Adding password for user exampleuser</code>。</p><p>htpasswd 文件的结构如下：</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>exampleuser:hased-passwd</span></span></code></pre></div><blockquote><p>请注意，运行 Nginx 的用户需要对生成的文件拥有可读权限。</p></blockquote></li><li><p>更新 Nginx 配置</p><p>在网站配置文件中的 <code>Server</code> 段添加下面两行：</p><div class="language-txt vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>server {</span></span>
<span class="line"><span>   auth_basic &quot;Restricted&quot;;</span></span>
<span class="line"><span>   auth_basic_user_file /etc/nginx/.htpasswd;</span></span>
<span class="line"><span>   # ...</span></span>
<span class="line"><span>}</span></span></code></pre></div></li><li><p>重载 Nginx</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nginx</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> reload</span></span></code></pre></div></li></ol><p>现在尝试访问网站或已保护的域路径，可以看到浏览器提示要求输入登录名和密码。</p><p>此时输入在创建 <code>.htpasswd</code> 文件时提供的用户名和密码信息，并且在入正确的凭据之前，提示不允许访问该网站。</p><h2 id="多个域名跨域支持" tabindex="-1">多个域名跨域支持 <a class="header-anchor" href="#多个域名跨域支持" aria-label="Permalink to &quot;多个域名跨域支持&quot;">​</a></h2><p>比如当前域名支持 <code>sub1.domain.com</code> 和 <code>sub2.domain.com</code> 的跨域请求支持，可以在 Nginx 配置文件中通过匹配 <code>$http_origin</code> 的值给定：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span># 允许代理域名访问当前域名下的静态资源的跨域支持</span></span>
<span class="line"><span>location / {</span></span>
<span class="line"><span>    if ($http_origin ~* (https?://(?:.+\.)?(sub1\.domain\.com|sub2\.domain\.com)$)) {</span></span>
<span class="line"><span>        add_header &#39;Access-Control-Allow-Origin&#39; &#39;$http_origin&#39;;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre></div></div></div></main><footer class="VPDocFooter" data-v-39a288b8 data-v-09de1c0f><!--[--><!--]--><div class="edit-info" data-v-09de1c0f><div class="edit-link" data-v-09de1c0f><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/curder/nginx-study/edit/master/docs/guide/examples.md" target="_blank" rel="noreferrer" data-v-09de1c0f><!--[--><span class="vpi-square-pen edit-link-icon" data-v-09de1c0f></span> 编辑它<!--]--></a></div><div class="last-updated" data-v-09de1c0f><p class="VPLastUpdated" data-v-09de1c0f data-v-7e05ebdb>最后更新时间: <time datetime="2024-08-21T09:42:07.000Z" data-v-7e05ebdb></time></p></div></div><!----></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"guide_modules_index.md\":\"BVZ4nriJ\",\"guide_modules_if.md\":\"xVB_F3FO\",\"guide_install.md\":\"BepLnP8k\",\"snippets_var-index.md\":\"BJb2vXih\",\"readme.md\":\"DWYaBG9U\",\"index.md\":\"BvAleK3A\",\"guide_examples.md\":\"DwiHn2GK\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"Nginx 学习\",\"description\":\"Nginx 学习记录\",\"base\":\"/nginx-study/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"logo\":\"/images/logo.svg\",\"siteTitle\":\"Nginx 学习\",\"outline\":{\"level\":\"deep\",\"label\":\"章节导航\"},\"lastUpdatedText\":\"最后更新时间\",\"docFooter\":{\"prev\":\"上一页\",\"next\":\"下一页\"},\"editLink\":{\"pattern\":\"https://github.com/curder/nginx-study/edit/master/docs/:path\",\"text\":\"编辑它\"},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/curder/nginx-study\"}],\"nav\":[{\"text\":\"安装\",\"link\":\"/guide/install\",\"activeMatch\":\"/guide/install\"},{\"text\":\"示例\",\"link\":\"/guide/examples\",\"activeMatch\":\"/guide/examples\"}],\"sidebar\":{}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>